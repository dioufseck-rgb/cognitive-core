# ═══════════════════════════════════════════════════════════════════
# Cognitive Core — Runtime Coordinator Configuration
#
# Fourth architectural layer. Manages governance, delegation,
# HITL policies, and cross-workflow contracts (A2A).
#
# This file is owned by Risk / Compliance / Ops — not by AI Engineers
# or domain SMEs. Changes here affect operational governance without
# touching workflows or domains.
# ═══════════════════════════════════════════════════════════════════

# ─── File Resolution ─────────────────────────────────────────────
workflow_dir: workflows
domain_dir: domains
case_dir: cases

# ─── Governance Tiers ────────────────────────────────────────────
# Every domain declares a tier via `governance: <tier>` in its YAML.
# The coordinator applies the posture defined here.

governance_tiers:
  auto:
    hitl: none
    sample_rate: 0.0

  spot_check:
    hitl: post_completion
    sample_rate: 0.10
    queue: qa_review
    sla: 7200   # 2 hours

  gate:
    hitl: before_act
    queue: specialist_review
    sla: 14400  # 4 hours

  hold:
    hitl: before_finalize
    queue: compliance_review
    sla: 172800  # 48 hours

# ─── Environment Overrides ───────────────────────────────────────
# Override domain tiers per environment. Use coordinator/overrides.*.yaml
# for env-specific settings, or inline here for defaults.

overrides: {}
  # Examples:
  # "*": gate           # everything gated in first month of prod
  # debit_spending: auto # except validated spending advisor

# ─── Quality Gates (Fail-Closed Rules) ──────────────────────────
# When workflow output confidence is below threshold, the coordinator
# upgrades governance to require human review regardless of the
# domain's declared tier. This prevents low-confidence AI decisions
# from reaching production without HITL.
#
# These are evaluated AFTER workflow completion but BEFORE the
# governance tier check in _on_completed.

quality_gates:
  # Global minimum confidence: any workflow step with confidence
  # below this triggers escalation to the gate queue.
  min_confidence: 0.5

  # Per-primitive confidence floors. These override the global
  # minimum for specific primitive types.
  primitive_floors:
    classify: 0.6
    investigate: 0.5
    verify: 0.5

  # When a quality gate fires, escalate to this tier
  escalation_tier: gate
  escalation_queue: quality_review

  # Skip quality gate checks for these domains
  # (e.g., domains already at hold tier don't need further escalation)
  # Provider/back-office domains are exempt: they use simulated tool data
  # so low retrieve confidence is expected and not meaningful for gating.
  exempt_domains:
    - underwriting_records
    - vendor_management
    - field_operations
    - subrogation

# ─── Delegation Policies ─────────────────────────────────────────
# Rules that trigger cross-workflow delegation. The coordinator
# evaluates these against completed workflow output.
# Workflows never see these policies.

delegations:

  # Card fraud patterns → AML investigation (fire and forget)
  # Source dispute completes immediately. SAR runs independently.
  # Results linked via correlation chain for audit.
  - name: fraud_pattern_triggers_aml
    mode: fire_and_forget  # default: source doesn't wait
    conditions:
      - domain: card_dispute
        selector: any_retrieve
        field: data.get_fraud_score.factors
        operator: contains_any
        value:
          - unknown_device
          - geolocation_anomaly
          - foreign_ip
          - multi_transaction_pattern
          - account_takeover
    target_workflow: sar_investigation
    target_domain: structuring_sar
    contract: aml_referral_v1
    sla: 86400  # 24 hours
    inputs:
      member_id: "${source.last_retrieve.data.get_member.member_id}"
      referral_reason: "Fraud dispute with high-risk indicators in fraud scoring"
      triggering_evidence: "${source.last_retrieve.data.get_fraud_score}"
      get_member: "${source.last_retrieve.data.get_member}"
      get_transactions: "${source.last_retrieve.data.get_transactions}"
      get_fraud_score: "${source.last_retrieve.data.get_fraud_score}"
      get_aml_alert: "${source.last_retrieve.data.get_fraud_score}"

  # Same trigger from investigation evidence flags (when investigation runs)
  - name: fraud_evidence_flags_trigger_aml
    mode: fire_and_forget
    conditions:
      - domain: card_dispute
        selector: any_investigate
        field: evidence_flags
        operator: contains_any
        value:
          - foreign_ip
          - unknown_device
          - multi_transaction_pattern
          - account_takeover
          - geographic_anomaly
    target_workflow: sar_investigation
    target_domain: structuring_sar
    contract: aml_referral_v1
    sla: 86400
    inputs:
      member_id: "${source.last_retrieve.data.get_member.member_id}"
      referral_reason: "${source.last_investigate.finding}"
      triggering_evidence: "${source.last_investigate.evidence_flags}"
      get_member: "${source.last_retrieve.data.get_member}"
      get_transactions: "${source.last_retrieve.data.get_transactions}"
      get_fraud_score: "${source.last_retrieve.data.get_fraud_score}"
      get_aml_alert: "${source.last_retrieve.data.get_fraud_score}"

  # SAR filed affecting multiple members → dispute reviews (blocking)
  # SAR suspends until all member disputes are reviewed, then
  # resumes at investigate_activity with enriched evidence.
  - name: sar_multi_member_disputes
    mode: wait_for_result  # SAR waits for dispute review to complete
    resume_at_step: investigate_activity  # resume investigation with new data
    conditions:
      - domain: structuring_sar
        selector: last_investigate
        field: affected_member_count
        operator: gte
        value: 2
    target_workflow: dispute_resolution
    target_domain: card_dispute
    contract: dispute_review_v1
    sla: 28800  # 8 hours
    inputs:
      member_id: "${source.last_investigate.affected_members}"
      referral_source: "${source.input.instance_id}"
      reason: cross_member_pattern
      get_member: "${source.last_retrieve.data.get_member}"
      get_transactions: "${source.last_retrieve.data.get_transactions}"
      get_aml_alert: "${source.last_retrieve.data.get_aml_alert}"

  # ─── Claim Intake Delegations (Multi-Agent) ────────────────────
  # Orchestrator pattern: claim_intake delegates to
  # damage_assessment + fraud_screening based on claim attributes.
  # Both are fire-and-forget: claim completes, assessments run independently.

  - name: claim_physical_damage_assessment
    mode: fire_and_forget
    conditions:
      - domain: synthetic_claim
        selector: last_verify
        field: conforms
        operator: eq
        value: true
      - domain: synthetic_claim
        selector: last_classify
        field: category
        operator: eq
        value: physical_damage
    target_workflow: damage_assessment
    target_domain: synthetic_damage
    contract: damage_assessment_v1
    sla: 3600  # 1 hour
    inputs:
      claim_id: "${source.last_retrieve.data.get_claim.claim_id}"
      policy_id: "${source.last_retrieve.data.get_policy.policy_id}"
      # Pass tool data so handler retrieve step can access them
      get_claim: "${source.last_retrieve.data.get_claim}"
      get_policy: "${source.last_retrieve.data.get_policy}"
      get_photos: "${source.input.get_photos}"
      get_estimate: "${source.input.get_estimate}"
      get_police_report: "${source.input.get_police_report}"

  - name: claim_high_value_fraud_screening
    mode: fire_and_forget
    conditions:
      - domain: synthetic_claim
        selector: last_verify
        field: conforms
        operator: eq
        value: true
      - domain: synthetic_claim
        selector: last_retrieve
        field: data.get_claim.amount
        operator: gte
        value: 5000
    target_workflow: fraud_screening
    target_domain: synthetic_fraud
    contract: fraud_screening_v1
    sla: 3600  # 1 hour
    inputs:
      claim_id: "${source.last_retrieve.data.get_claim.claim_id}"
      amount: "${source.last_retrieve.data.get_claim.amount}"
      # Pass tool data so handler retrieve step can access them
      get_claim: "${source.last_retrieve.data.get_claim}"
      get_policy: "${source.last_retrieve.data.get_policy}"
      get_claim_history: "${source.input.get_claim_history}"
      get_flags: "${source.input.get_flags}"

  # ─── Product Return Delegations ───────────────────────────────

  # Suspicious return patterns → fraud review (blocking)
  # Return workflow suspends until fraud assessment completes.
  # Fraud result informs the resolution decision.
  - name: return_fraud_indicators_trigger_review
    mode: wait_for_result
    resume_at_step: decide_resolution
    conditions:
      - domain: electronics_return
        selector: any_investigate
        field: evidence_flags
        operator: contains_any
        value:
          - serial_electronics_returner
          - high_return_rate
          - wardrobing_suspected
          - repeat_product_line_returns
          - consistent_defect_claims
    target_workflow: fraud_review
    target_domain: return_fraud
    contract: fraud_review_v1
    sla: 3600  # 1 hour
    inputs:
      customer_id: "${source.input.customer_id}"
      referral_reason: "${source.last_investigate.finding}"
      triggering_evidence: "${source.last_investigate.evidence_flags}"
      # Pass tool data so handler's retrieve step can access them
      get_customer: "${source.input.get_customer}"
      get_return_history: "${source.input.get_return_history}"
      get_fraud_signals: "${source.input.get_fraud_signals}"

  # High-value electronics returns → vendor notification (fire-and-forget)
  # Return completes immediately. Vendor is notified independently.
  - name: high_value_return_vendor_notify
    mode: fire_and_forget
    conditions:
      - domain: electronics_return
        selector: any_retrieve
        field: data.get_order.item_price
        operator: gte
        value: 500
    target_workflow: vendor_notification
    target_domain: vendor_ops
    contract: vendor_return_v1
    sla: 86400  # 24 hours
    inputs:
      order_id: "${source.input.order_id}"
      customer_name: "${source.last_retrieve.data.get_customer.name}"
      return_reason: "${source.input.return_reason}"
      item_condition: "${source.input.item_condition}"
      # Pass tool data so handler's retrieve step can access them
      get_vendor: "${source.input.get_vendor}"
      get_product: "${source.input.get_product}"
      get_order: "${source.input.get_order}"

  # ─── Member Hardship Lifecycle Delegations ──────────────────────
  # Five-workflow orchestration: intake → eligibility → recommendation
  # → contact strategy → action execution.
  # Coordinator chains these via fire-and-forget with suspend/resume
  # at governance gates.

  # WF1 completes → WF2 fires (eligibility assessment)
  - name: hardship_intake_to_eligibility
    mode: fire_and_forget
    conditions:
      - domain: member_hardship
        selector: last_generate
        field: artifact.preliminary_triage
        operator: in
        value:
          - straightforward
          - complex
          - urgent
    target_workflow: eligibility_constraints_assessment
    target_domain: hardship_eligibility
    contract: hardship_eligibility_v1
    sla: 7200  # 2 hours
    inputs:
      intake_packet: "${source.last_generate.artifact}"
      member_token: "${source.last_generate.artifact.member_token}"
      get_risk_flags: "${source.last_retrieve.data.get_risk_flags}"
      get_legal_flags: "${source.last_retrieve.data.get_legal_flags}"
      get_product_rules: "${source.last_retrieve.data.get_loan_accounts}"
      get_policy_config: "{}"

  # WF2 completes → WF3 fires (path recommendation)
  - name: hardship_eligibility_to_recommendation
    mode: fire_and_forget
    conditions:
      - domain: hardship_eligibility
        selector: last_generate
        field: artifact.required_human_review
        operator: eq
        value: false
    target_workflow: hardship_path_recommendation
    target_domain: hardship_path
    contract: hardship_recommendation_v1
    sla: 3600  # 1 hour
    inputs:
      intake_packet: "${source.input.intake_packet}"
      constraints: "${source.last_generate.artifact}"

  # WF3 completes → WF4 fires (contact strategy)
  - name: hardship_recommendation_to_contact
    mode: fire_and_forget
    conditions:
      - domain: hardship_path
        selector: last_generate
        field: artifact.selected_path
        operator: in
        value:
          - P0
          - P1
          - P2
          - P3
    target_workflow: member_contact_strategy
    target_domain: hardship_contact
    contract: hardship_contact_v1
    sla: 3600
    inputs:
      intake_packet: "${source.input.intake_packet}"
      constraints: "${source.input.constraints}"
      recommendation: "${source.last_generate.artifact}"

  # WF2 SCRA detected → specialist sub-assessment (fire and forget)
  - name: hardship_scra_specialist
    mode: fire_and_forget
    conditions:
      - domain: hardship_eligibility
        selector: last_classify
        field: category
        operator: in
        value:
          - scra_protected
          - multiple_constraints
    target_workflow: eligibility_constraints_assessment
    target_domain: hardship_eligibility
    contract: hardship_eligibility_v1
    sla: 14400  # 4 hours
    inputs:
      intake_packet: "${source.input.intake_packet}"
      assessment_focus: "scra"

  # WF2 Fraud/exploitation detected → security freeze
  - name: hardship_fraud_exploitation_freeze
    mode: fire_and_forget
    conditions:
      - domain: hardship_eligibility
        selector: last_classify
        field: category
        operator: eq
        value: fraud_exploitation
    target_workflow: eligibility_constraints_assessment
    target_domain: hardship_eligibility
    contract: hardship_eligibility_v1
    sla: 3600
    inputs:
      intake_packet: "${source.input.intake_packet}"
      assessment_focus: "fraud_exploitation"

# ─── Contracts ───────────────────────────────────────────────────
# Versioned interface schemas for cross-workflow delegation.
# Neither sender nor receiver knows the other's identity.

contracts:

  damage_assessment_v1:
    version: 1
    request:
      - name: claim_id
        type: string
        required: true
      - name: policy_id
        type: string
        required: false
    response:
      - name: damage_grade
        type: enum
        required: true
        enum_values:
          - minor
          - moderate
          - major
          - total_loss
      - name: repair_cost
        type: float
        required: true
      - name: documentation_complete
        type: bool
        required: true

  fraud_screening_v1:
    version: 1
    request:
      - name: claim_id
        type: string
        required: true
      - name: amount
        type: float
        required: false
    response:
      - name: fraud_risk
        type: enum
        required: true
        enum_values:
          - low_risk
          - medium_risk
          - high_risk
      - name: recommendation
        type: string
        required: true

  aml_referral_v1:
    version: 1
    request:
      - name: member_id
        type: string
        required: true
      - name: referral_reason
        type: string
        required: true
      - name: triggering_evidence
        type: object
        required: false
    response:
      - name: filing_decision
        type: enum
        required: true
        enum_values:
          - file_sar
          - close_no_action
          - request_more_info
      - name: risk_assessment
        type: enum
        required: true
        enum_values:
          - low
          - moderate
          - elevated
          - high
      - name: sar_reference
        type: string
        required: false
      - name: recommended_actions
        type: list
        required: false

  dispute_review_v1:
    version: 1
    request:
      - name: member_id
        type: string
        required: true
      - name: referral_source
        type: string
        required: false
      - name: reason
        type: string
        required: true
    response:
      - name: resolution
        type: string
        required: true
      - name: credit_applied
        type: string
        required: false

  fraud_review_v1:
    version: 1
    request:
      - name: customer_id
        type: string
        required: true
      - name: referral_reason
        type: string
        required: true
      - name: triggering_evidence
        type: object
        required: false
    response:
      - name: risk_level
        type: string
        required: true
      - name: recommendation
        type: string
        required: true
      - name: account_action
        type: string
        required: false

  vendor_return_v1:
    version: 1
    request:
      - name: order_id
        type: string
        required: true
      - name: customer_name
        type: string
        required: true
      - name: return_reason
        type: string
        required: true
      - name: item_condition
        type: string
        required: false
    response:
      - name: notification_sent
        type: string
        required: true
      - name: rma_number
        type: string
        required: false

  # ─── Hardship Lifecycle Contracts ──────────────────────────────

  hardship_eligibility_v1:
    version: 1
    request:
      - name: intake_packet
        type: object
        required: true
      - name: member_token
        type: string
        required: false
    response:
      - name: eligibility
        type: list
        required: true
      - name: global_constraints
        type: object
        required: true
      - name: required_human_review
        type: bool
        required: true

  hardship_recommendation_v1:
    version: 1
    request:
      - name: intake_packet
        type: object
        required: true
      - name: constraints
        type: object
        required: true
    response:
      - name: selected_path
        type: string
        required: true
      - name: plan_options
        type: list
        required: true
      - name: confidence_score
        type: float
        required: true
      - name: required_human_review
        type: bool
        required: true

  hardship_contact_v1:
    version: 1
    request:
      - name: intake_packet
        type: object
        required: true
      - name: constraints
        type: object
        required: true
      - name: recommendation
        type: object
        required: true
    response:
      - name: channel
        type: string
        required: true
      - name: template_ids
        type: list
        required: false
      - name: escalation_needed
        type: bool
        required: true

  hardship_action_v1:
    version: 1
    request:
      - name: action_request
        type: object
        required: true
      - name: constraints
        type: object
        required: true
      - name: recommendation
        type: object
        required: true
    response:
      - name: action_type
        type: string
        required: true
      - name: status
        type: enum
        required: true
        enum_values:
          - completed
          - failed
          - rejected
          - pending_approval
      - name: audit_id
        type: string
        required: false

  # ── Insurance Claim Adjudication Contracts ─────────────────────

  equipment_schedule_v1:
    version: 1
    request:
      - name: policy_number
        type: string
        required: true
      - name: equipment
        type: string
        required: true
    response:
      - name: asset_listed
        type: bool
        required: true
      - name: sublimit
        type: float
        required: false
      - name: deductible
        type: float
        required: false

  forensic_review_v1:
    version: 1
    request:
      - name: claim_id
        type: string
        required: true
      - name: claimed_bi
        type: float
        required: true
    response:
      - name: verified_bi
        type: float
        required: true
      - name: adjustment
        type: float
        required: false

  coi_retrieval_v1:
    version: 1
    request:
      - name: contractor
        type: string
        required: true
    response:
      - name: coi_found
        type: bool
        required: true
      - name: gl_limit
        type: float
        required: false

  scheduling_v1:
    version: 1
    request:
      - name: location
        type: string
        required: true
    response:
      - name: assigned_adjuster
        type: string
        required: true
      - name: scheduled_date
        type: string
        required: true

  recovery_analysis_v1:
    version: 1
    request:
      - name: net_payable
        type: float
        required: true
    response:
      - name: recommended
        type: string
        required: true
      - name: expected_net_recovery
        type: float
        required: true

  coverage_review_v1:
    version: 1
    request:
      - name: policy_clause
        type: string
        required: true
    response:
      - name: determination
        type: string
        required: true

  appraisal_v1:
    version: 1
    request:
      - name: claim_id
        type: string
        required: true
    response:
      - name: appraised_value
        type: float
        required: true

# ─── Capability Catalog ──────────────────────────────────────────
# Maps need types to providers. Workflows report needs;
# the coordinator matches them here.

capabilities:

  - need: member_communication
    type: human_task
    queue: member_outreach
    contract: member_inquiry_v1

  # ── Insurance claim adjudication capabilities (demand-driven) ──

  - need: scheduled_equipment_verification
    type: workflow
    workflow: equipment_schedule_lookup
    domain: underwriting_records
    contract: equipment_schedule_v1

  - need: forensic_accounting_review
    type: human_task
    queue: specialist_forensic_accounting
    contract: forensic_review_v1

  - need: third_party_coi_retrieval
    type: workflow
    workflow: vendor_coi_lookup
    domain: vendor_management
    contract: coi_retrieval_v1

  - need: adjuster_scheduling
    type: workflow
    workflow: field_scheduling_optimizer
    domain: field_operations
    contract: scheduling_v1

  - need: subrogation_recovery_analysis
    type: workflow
    workflow: recovery_optimizer
    domain: subrogation
    contract: recovery_analysis_v1

  - need: coverage_specialist_review
    type: human_task
    queue: coverage_specialist
    contract: coverage_review_v1

  - need: independent_appraisal
    type: human_task
    queue: independent_appraiser
    contract: appraisal_v1


# ═══════════════════════════════════════════════════════════════════
# Dispatch Optimization Defaults (Spec v1.1)
# ═══════════════════════════════════════════════════════════════════
# These apply when a domain YAML does not have its own `optimization:` section.

optimization_defaults:
  archetype: assignment
  physics: default
  objectives:
    minimize_cost: 0.3
    minimize_wait_time: 0.5
    minimize_sla_risk: 0.2
  solver_time_budget: 5s
  greedy_fallback: true
  exploration:
    enabled: true
    maturity_threshold: 10
    base_epsilon: 0.10
    novelty_bonus: 0.05
    max_exploration_pct: 0.15
    sla_gate:
      - routine
      - high
