# Cognitive Core â€” Worker
# Build: docker build -f Dockerfile.worker -t cognitive-core-worker .
# Run:   docker run -e LLM_PROVIDER=google -e GOOGLE_API_KEY=... -e REDIS_URL=redis://redis:6379 cognitive-core-worker

FROM python:3.12-slim AS base

WORKDIR /app

# System deps
RUN apt-get update && apt-get install -y --no-install-recommends \
    gcc libffi-dev && \
    rm -rf /var/lib/apt/lists/*

# Python deps
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt && \
    pip install --no-cache-dir arq redis

# Application code
COPY engine/ engine/
COPY coordinator/ coordinator/
COPY registry/ registry/
COPY fixtures/ fixtures/
COPY mcp_servers/ mcp_servers/
COPY workflows/ workflows/
COPY domains/ domains/
COPY cases/ cases/
COPY evals/ evals/
COPY api/ api/
COPY llm_config.yaml .

# Non-root user
RUN useradd -m -s /bin/bash appuser
USER appuser

ENV CC_PROJECT_ROOT=/app
ENV PYTHONUNBUFFERED=1
ENV REDIS_URL=redis://localhost:6379

# arq worker entry point
CMD ["python", "-m", "api.arq_worker"]
