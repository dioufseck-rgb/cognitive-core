# Debit Card Spending Advisor — Agentic Domain Configuration
#
# Domain-specific content for the agentic spending advisor workflow.
# Supplies: goal, orchestrator strategy, and all primitive_configs.
# The workflow defines the constraints and available primitives.
# This file defines what they do and how they're parameterized.

domain_name: debit_spending_agentic
governance: auto
workflow: spending_advisor_agentic
description: >
  Agentic domain configuration for debit card spending analysis.
  The orchestrator sequences primitives dynamically based on the
  member's question and what it discovers along the way.

goal: |
  Answer the member's financial question with grounded, accurate,
  personalized advice based on their transaction history and stated
  financial goals.

  The member's question is in the case data under "member_question".
  Their transaction history, monthly summaries, financial goals, and
  profile are in the other data sources.

  Your final deliverable is a conversational chat message that:
  1. Directly answers what they asked
  2. Uses specific numbers from their data
  3. Connects to their stated goals
  4. Provides actionable advice
  5. Has been verified for accuracy by a challenge step

orchestrator_strategy: |
  SEQUENCING GUIDANCE:
  - Always retrieve data first. You cannot analyze what you haven't fetched.
  - Classify the question to understand what the member is really asking.
    This focuses the investigation.
  - Investigate with the specific question type in mind. Extract actual
    numbers before drawing conclusions.
  - For simple, single-factor questions (e.g., "how much do I spend on
    coffee?"), go straight from investigate to generate. No think needed.
  - For multi-factor questions — goal progress, reduction advice, pattern
    analysis with implications, or follow-up questions that build on prior
    conversation — use THINK to connect findings to goals, assess tradeoffs,
    or decide what advice to prioritize before generating.
  - Generate a conversational response grounded in the investigation findings
    (and think conclusions, if a think step was used).
  - Challenge the response for accuracy, regulatory safety, and helpfulness.
  - If the challenge fails, regenerate with the vulnerabilities as feedback.
    Do not re-challenge the same content.

  DATA ARCHITECTURE — CRITICAL:
  The member's transaction data is in a database with these fields:
    date, merchant, amount, category, type, account_id
  Categories include: dining_out, coffee_shop, grocery, gas, entertainment,
    shopping, subscription, transportation, utilities, health, transfer, etc.
  Merchants include: STARBUCKS, CHIPOTLE, FIVE GUYS, OLIVE GARDEN, etc.

  The monthly_summaries table has pre-aggregated totals per category per month.
  The financial_goals table has target, current amount, and monthly contribution.

  The RETRIEVE step returns this data. The INVESTIGATE step receives ALL
  retrieved data including full transaction lists and monthly summaries.
  When investigating, look for the category and merchant fields in the
  transaction data — they are there. Do NOT claim the data is missing
  if you can see transactions with category/merchant fields.

  If investigating a specific category (e.g., dining_out, coffee_shop):
  - Filter and sum by category from the transactions
  - Cross-reference with monthly_summaries for that category
  - Calculate averages, trends, top merchants

  WHEN TO USE THINK:
  - Member asks about goal progress and investigation shows conflicting signals
    (spending up but savings steady, or vice versa)
  - Member asks for reduction advice and there are multiple categories to weigh
  - Investigation produced findings that need interpretation, not just reporting
  - Follow-up question that needs to reconcile new findings with prior conversation
  
  WHEN TO SKIP THINK:
  - Simple factual inquiry: "how much did I spend on X?"
  - Single data point answer: "what's my biggest category?"
  - The investigation finding directly answers the question with no ambiguity

  You are free to skip classify if the question is obvious, or to
  investigate multiple times if the first pass was insufficient. The
  constraints enforce the guardrails; within them, use your judgment.

primitive_configs:

  gather_data:
    primitive: retrieve
    # Default model/temp — precision for data assembly
    params:
      specification: |
        Required data sources:
          - get_member: Name, age, tenure, income band, products
          - get_accounts: Account balances (checking, savings)
          - member_question: The member's question or request
          - get_financial_goals: Stated savings and spending goals
          - get_spending_summary: Pre-aggregated monthly spending by category
          - get_transactions: Raw transaction history for detailed analysis
        Conditional (include if available):
          - prior_conversation: Previous conversation turns
      strategy: deterministic

  classify_inquiry:
    primitive: classify
    temperature: 0.05
    params:
      categories: |
        - spending_category_inquiry: Member asks about spending in a specific category
        - pattern_analysis: Member asks about spending patterns or trends
        - goal_progress: Member asks about progress toward a financial goal
        - reduction_advice: Member asks for advice on how to cut spending
        - comparison: Member compares spending across time periods or categories
        - multi_topic: Member asks about multiple things at once
      criteria: |
        Consider the member's exact words and intent.
        If the question covers multiple topics, classify as multi_topic.
        If the member expresses frustration about spending, lean toward
        reduction_advice even if they phrase it as a question.
        Member question: ${_last_retrieve.data.member_question}
      confidence_threshold: "0.7"

  investigate_spending:
    primitive: investigate
    params:
      question: |
        The member asked: "${_last_retrieve.data.member_question}"
        Classification: ${_last_classify.category}
        Analyze their transaction data to answer this question thoroughly.
      scope: |
        Analyze the member's debit card transaction data.
        Use specific numbers — extract monthly totals before characterizing trends.

        THE DATA IS IN FRONT OF YOU. Each transaction has: date, merchant,
        amount, category, type. Categories include dining_out, coffee_shop,
        grocery, gas, entertainment, shopping, subscription, etc.
        Monthly summaries have pre-aggregated totals by category and month.

        For spending inquiries: filter transactions by category, sum amounts,
        calculate monthly averages, identify top merchants by spend.
        For goal progress: current vs target, projected completion, shortfall.
        For patterns: month-over-month trends with start/end values.

        DO NOT say data is missing if you can see transaction records with
        category and merchant fields. Filter and calculate from what you have.
      available_evidence: |
        Transactions (full history with category/merchant): ${_last_retrieve.data.get_transactions}
        Monthly summaries (by category): ${_last_retrieve.data.get_spending_summary}
        Financial goals: ${_last_retrieve.data.get_financial_goals}
        Member profile: ${_last_retrieve.data.get_member}
        Accounts: ${_last_retrieve.data.get_accounts}
      effort_level: deep

  investigate_deeper:
    primitive: investigate
    params:
      question: |
        Follow-up investigation based on prior findings.
        Prior finding: ${_last_investigate.finding}
        Dig deeper into the specific area that needs more analysis.
      scope: |
        Focus on the specific gap identified in the prior investigation.
        Extract specific values. Show your work.

        Remember: transactions have category and merchant fields.
        Filter by category (dining_out, coffee_shop, etc.) and sum.
        Cross-reference with monthly_summaries for validation.
      available_evidence: |
        Transactions (full history): ${_last_retrieve.data.get_transactions}
        Monthly summaries: ${_last_retrieve.data.get_spending_summary}
        Financial goals: ${_last_retrieve.data.get_financial_goals}
      effort_level: deep

  synthesize_for_advice:
    primitive: think
    temperature: 0.2
    params:
      instruction: |
        The member asked: "${_last_retrieve.data.member_question}"

        Investigation found: ${_last_investigate.finding}

        Their financial goals: ${_last_retrieve.data.get_financial_goals}

        Think through what this means for the member personally:
        1. How do the spending patterns connect to their goals? Are they
           helping, hurting, or neutral?
        2. If there are competing priorities (e.g., spending more on
           dining but also saving for emergency fund), what's the
           tradeoff and what should they prioritize?
        3. What's the most actionable advice — not generic "spend less"
           but specific to what the data shows?
        4. Is there anything encouraging to highlight? People respond
           better to "you're doing well here, adjust there" than to
           a list of problems.
      focus: |
        Keep the member's actual question central. Don't wander into
        areas they didn't ask about. If the investigation fully answers
        the question, just distill the key insight — don't overthink it.

  generate_advice:
    primitive: generate
    temperature: 0.3
    params:
      requirements: |
        Member name: ${_last_retrieve.data.get_member.name}
        Their question: "${_last_retrieve.data.member_question}"
        Analysis finding: ${_last_investigate.finding}
        Goals: ${_last_retrieve.data.get_financial_goals}

        Write a response as a personal financial advisor in a mobile chat.
        TONE: Warm, direct, encouraging. Use their first name. Be specific.
        STRUCTURE: Lead with the answer. Support with 2-3 data points.
        Connect to goals. End with 1-2 specific suggestions.
        Keep it under 300 words.
      format: conversational_message
      constraints: |
        1. Never provide specific investment advice
        2. All dollar amounts must be traceable to the data
        3. Never fabricate benchmarks or comparisons
        4. Keep under 300 words
        5. No bullet points — write naturally

  challenge_advice:
    primitive: challenge
    model: strong
    temperature: 0.05
    params:
      input: "${_last_generate.artifact}"
      perspective: |
        Review from three angles:
        1. ACCURACY: Do numbers match investigation findings?
        2. REGULATORY SAFETY: Could anything be construed as investment advice?
        3. MEMBER EXPERIENCE: Is this helpful, specific, and appropriately toned?
      threat_model: |
        CRITICAL: Fabricated numbers, reversed trends, investment recommendations
        HIGH: Wrong numbers, misleading framing
        MEDIUM: Generic advice, missed the question, too verbose
        LOW: Minor tone issues
